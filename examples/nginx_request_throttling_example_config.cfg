# Rate limiting zone (10MB shared memory, 10 req/sec per IP)
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

upstream nprpc_backend {
    server 127.0.0.1:8080;  # Your HTTP/1.1
    keepalive 32;
}

server {
    listen 443 ssl http2;
    listen 443 quic reuseport;  # HTTP/3
    
    # Rate limiting
    location /rpc {
        limit_req zone=api_limit burst=20 nodelay;
        limit_conn conn_limit 10;
        
        proxy_pass http://nprpc_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
    
    # Static files - more lenient
    location / {
        limit_req zone=api_limit burst=50;
        proxy_pass http://nprpc_backend;
    }
}