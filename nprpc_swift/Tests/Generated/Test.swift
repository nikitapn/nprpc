// Generated by npidl compiler
// DO NOT EDIT - all changes will be lost

import NPRPC

public enum Color: Int {
  case red
  case green
  case blue
}

public struct Point: Codable, Sendable {
  public var x: Int32
  public var y: Int32

  public init(x: Int32, y: Int32)   {
    self.x = x
    self.y = y
  }
}


// MARK: - Marshal Point
public func marshal_Point(buffer: UnsafeMutableRawPointer, offset: Int, data: Point) {
  buffer.storeBytes(of: data.x, toByteOffset: offset + 0, as: Int32.self)
  buffer.storeBytes(of: data.y, toByteOffset: offset + 4, as: Int32.self)
}

// MARK: - Unmarshal Point
public func unmarshal_Point(buffer: UnsafeRawPointer, offset: Int) -> Point {
  var result = Point()
  result.x = buffer.load(fromByteOffset: offset + 0, as: Int32.self)
  result.y = buffer.load(fromByteOffset: offset + 4, as: Int32.self)
  return result
}

public struct Rectangle: Codable, Sendable {
  public var topLeft: Point
  public var bottomRight: Point
  public var color: Color

  public init(topLeft: Point, bottomRight: Point, color: Color)   {
    self.topLeft = topLeft
    self.bottomRight = bottomRight
    self.color = color
  }
}


// MARK: - Marshal Rectangle
public func marshal_Rectangle(buffer: UnsafeMutableRawPointer, offset: Int, data: Rectangle) {
  marshal_Point(buffer: buffer, offset: offset + 0, data: data.topLeft)
  marshal_Point(buffer: buffer, offset: offset + 8, data: data.bottomRight)
  buffer.storeBytes(of: data.color.rawValue, toByteOffset: offset + 16, as: Int32.self)
}

// MARK: - Unmarshal Rectangle
public func unmarshal_Rectangle(buffer: UnsafeRawPointer, offset: Int) -> Rectangle {
  var result = Rectangle()
  result.topLeft = unmarshal_Point(buffer: buffer, offset: offset + 0)
  result.bottomRight = unmarshal_Point(buffer: buffer, offset: offset + 8)
  result.color = Color(rawValue: buffer.load(fromByteOffset: offset + 16, as: Int32.self))!
  return result
}

public protocol CalculatorProtocol {
  func add(a: Int32, b: Int32) throws -> Int32
  func divide(numerator: Double, denominator: Double) throws -> Double
}

// Client proxy for Calculator
// Pure Swift implementation with direct marshalling
public class Calculator: CalculatorProtocol {
  private let object: NPRPCObject

  public init(_ object: NPRPCObject)   {
    self.object = object
  }

  public func add(a: Int32, b: Int32) throws -> Int32   {
    // Prepare buffer
    let buffer = FlatBuffer()
    buffer.prepare(40)
    buffer.commit(40)
    guard let data = buffer.data else { throw NPRPCError.bufferError }

    // Write message header
    data.storeBytes(of: UInt32(0), toByteOffset: 0, as: UInt32.self)  // size (set later)
    data.storeBytes(of: UInt32(1), toByteOffset: 4, as: UInt32.self)  // msg_id: FunctionCall
    data.storeBytes(of: UInt32(0), toByteOffset: 8, as: UInt32.self)  // msg_type: Request
    data.storeBytes(of: UInt32(0), toByteOffset: 12, as: UInt32.self) // reserved

    // Write call header
    data.storeBytes(of: object.poaIdx, toByteOffset: 16, as: UInt16.self)
    data.storeBytes(of: UInt8(0), toByteOffset: 18, as: UInt8.self)  // interface_idx
    data.storeBytes(of: UInt8(0), toByteOffset: 19, as: UInt8.self)  // function_idx
    data.storeBytes(of: object.objectId, toByteOffset: 24, as: UInt64.self)

    // Marshal input arguments
    let inArgs = (_1: a, _2: b)
    marshal_test_swift_gen_M1(buffer: data, offset: 32, data: inArgs)

    data.storeBytes(of: UInt32(36), toByteOffset: 0, as: UInt32.self)

    // Send and receive
    try object.session.sendReceive(buffer: buffer, timeout: object.timeout)

    // Handle reply
    let stdReply = handleStandardReply(buffer: buffer)
    if stdReply != -1 { throw NPRPCError.unexpectedReply }

    guard let responseData = buffer.data else { throw NPRPCError.bufferError }
    let out = unmarshal_test_swift_gen_M2(buffer: responseData, offset: 16)
    return out._1
  }

  public func divide(numerator: Double, denominator: Double) throws -> Double   {
    // Prepare buffer
    let buffer = FlatBuffer()
    buffer.prepare(48)
    buffer.commit(48)
    guard let data = buffer.data else { throw NPRPCError.bufferError }

    // Write message header
    data.storeBytes(of: UInt32(0), toByteOffset: 0, as: UInt32.self)  // size (set later)
    data.storeBytes(of: UInt32(1), toByteOffset: 4, as: UInt32.self)  // msg_id: FunctionCall
    data.storeBytes(of: UInt32(0), toByteOffset: 8, as: UInt32.self)  // msg_type: Request
    data.storeBytes(of: UInt32(0), toByteOffset: 12, as: UInt32.self) // reserved

    // Write call header
    data.storeBytes(of: object.poaIdx, toByteOffset: 16, as: UInt16.self)
    data.storeBytes(of: UInt8(0), toByteOffset: 18, as: UInt8.self)  // interface_idx
    data.storeBytes(of: UInt8(1), toByteOffset: 19, as: UInt8.self)  // function_idx
    data.storeBytes(of: object.objectId, toByteOffset: 24, as: UInt64.self)

    // Marshal input arguments
    let inArgs = (_1: numerator, _2: denominator)
    marshal_test_swift_gen_M3(buffer: data, offset: 32, data: inArgs)

    data.storeBytes(of: UInt32(44), toByteOffset: 0, as: UInt32.self)

    // Send and receive
    try object.session.sendReceive(buffer: buffer, timeout: object.timeout)

    // Handle reply
    let stdReply = handleStandardReply(buffer: buffer)
    if stdReply != -1 { throw NPRPCError.unexpectedReply }

    guard let responseData = buffer.data else { throw NPRPCError.bufferError }
    let out = unmarshal_test_swift_gen_M4(buffer: responseData, offset: 16)
    return out._1
  }

}

// Servant base for Calculator
open class CalculatorServant: NPRPCServant, CalculatorProtocol {
  public override init() { super.init() }

  open func add(a: Int32, b: Int32) throws -> Int32   {
    fatalError("Subclass must implement add")
  }

  open func divide(numerator: Double, denominator: Double) throws -> Double   {
    fatalError("Subclass must implement divide")
  }

  // Dispatch incoming RPC calls
  public override func dispatch(buffer: FlatBuffer, remoteEndpoint: NPRPCEndpoint)   {
    guard let data = buffer.data else { return }

    // Read function index
    let functionIdx = data.load(fromByteOffset: 19, as: UInt8.self)

    switch functionIdx     {
      case 0: // add
      {
        
// Unmarshal input arguments
        let ia = unmarshal_test_swift_gen_M1(buffer: data, offset: 32)
        
        let _out_result = try add(a: ia._1, b: ia._2)
        
// Prepare output buffer
        let obuf = buffer
        obuf.consume(obuf.size)
        obuf.prepare(20)
        obuf.commit(20)
        
// Marshal output arguments
        guard let outData = buffer.data else { return }
        let out_data = (_1: _out_result)
        marshal_test_swift_gen_M2(buffer: outData, offset: 16, data: out_data)
        outData.storeBytes(of: UInt32(buffer.size - 4), toByteOffset: 0, as: UInt32.self)
        outData.storeBytes(of: UInt32(2), toByteOffset: 4, as: UInt32.self)  // MessageId.BlockResponse
        outData.storeBytes(of: UInt32(1), toByteOffset: 8, as: UInt32.self)  // MessageType.Answer
      }
      case 1: // divide
      {
        
// Unmarshal input arguments
        let ia = unmarshal_test_swift_gen_M3(buffer: data, offset: 32)
        
        let _out_result = try divide(numerator: ia._1, denominator: ia._2)
        
// Prepare output buffer
        let obuf = buffer
        obuf.consume(obuf.size)
        obuf.prepare(24)
        obuf.commit(24)
        
// Marshal output arguments
        guard let outData = buffer.data else { return }
        let out_data = (_1: _out_result)
        marshal_test_swift_gen_M4(buffer: outData, offset: 16, data: out_data)
        outData.storeBytes(of: UInt32(buffer.size - 4), toByteOffset: 0, as: UInt32.self)
        outData.storeBytes(of: UInt32(2), toByteOffset: 4, as: UInt32.self)  // MessageId.BlockResponse
        outData.storeBytes(of: UInt32(1), toByteOffset: 8, as: UInt32.self)  // MessageType.Answer
      }
      default:
      {
        makeSimpleAnswer(buffer: buffer, messageId: 10)  // Error_UnknownFunctionIdx
      }
    }
 // switch
  }
 // dispatch
}

public protocol ShapeServiceProtocol {
  func getRectangle(id: UInt32) throws -> Rectangle
  func setRectangle(id: UInt32, rect: Rectangle) throws
}

// Client proxy for ShapeService
// Pure Swift implementation with direct marshalling
public class ShapeService: ShapeServiceProtocol {
  private let object: NPRPCObject

  public init(_ object: NPRPCObject)   {
    self.object = object
  }

  public func getRectangle(id: UInt32) throws -> Rectangle   {
    // Prepare buffer
    let buffer = FlatBuffer()
    buffer.prepare(36)
    buffer.commit(36)
    guard let data = buffer.data else { throw NPRPCError.bufferError }

    // Write message header
    data.storeBytes(of: UInt32(0), toByteOffset: 0, as: UInt32.self)  // size (set later)
    data.storeBytes(of: UInt32(1), toByteOffset: 4, as: UInt32.self)  // msg_id: FunctionCall
    data.storeBytes(of: UInt32(0), toByteOffset: 8, as: UInt32.self)  // msg_type: Request
    data.storeBytes(of: UInt32(0), toByteOffset: 12, as: UInt32.self) // reserved

    // Write call header
    data.storeBytes(of: object.poaIdx, toByteOffset: 16, as: UInt16.self)
    data.storeBytes(of: UInt8(0), toByteOffset: 18, as: UInt8.self)  // interface_idx
    data.storeBytes(of: UInt8(0), toByteOffset: 19, as: UInt8.self)  // function_idx
    data.storeBytes(of: object.objectId, toByteOffset: 24, as: UInt64.self)

    // Marshal input arguments
    let inArgs = (_1: id)
    marshal_test_swift_gen_M5(buffer: data, offset: 32, data: inArgs)

    data.storeBytes(of: UInt32(32), toByteOffset: 0, as: UInt32.self)

    // Send and receive
    try object.session.sendReceive(buffer: buffer, timeout: object.timeout)

    // Handle reply
    let stdReply = handleStandardReply(buffer: buffer)
    if stdReply != -1 { throw NPRPCError.unexpectedReply }

    guard let responseData = buffer.data else { throw NPRPCError.bufferError }
    let out = unmarshal_test_swift_gen_M6(buffer: responseData, offset: 16)
    return out._1
  }

  public func setRectangle(id: UInt32, rect: Rectangle) throws   {
    // Prepare buffer
    let buffer = FlatBuffer()
    buffer.prepare(56)
    buffer.commit(56)
    guard let data = buffer.data else { throw NPRPCError.bufferError }

    // Write message header
    data.storeBytes(of: UInt32(0), toByteOffset: 0, as: UInt32.self)  // size (set later)
    data.storeBytes(of: UInt32(1), toByteOffset: 4, as: UInt32.self)  // msg_id: FunctionCall
    data.storeBytes(of: UInt32(0), toByteOffset: 8, as: UInt32.self)  // msg_type: Request
    data.storeBytes(of: UInt32(0), toByteOffset: 12, as: UInt32.self) // reserved

    // Write call header
    data.storeBytes(of: object.poaIdx, toByteOffset: 16, as: UInt16.self)
    data.storeBytes(of: UInt8(0), toByteOffset: 18, as: UInt8.self)  // interface_idx
    data.storeBytes(of: UInt8(1), toByteOffset: 19, as: UInt8.self)  // function_idx
    data.storeBytes(of: object.objectId, toByteOffset: 24, as: UInt64.self)

    // Marshal input arguments
    let inArgs = (_1: id, _2: rect)
    marshal_test_swift_gen_M7(buffer: data, offset: 32, data: inArgs)

    data.storeBytes(of: UInt32(52), toByteOffset: 0, as: UInt32.self)

    // Send and receive
    try object.session.sendReceive(buffer: buffer, timeout: object.timeout)

    // Handle reply
    let stdReply = handleStandardReply(buffer: buffer)
    if stdReply != 0 { throw NPRPCError.unexpectedReply }
  }

}

// Servant base for ShapeService
open class ShapeServiceServant: NPRPCServant, ShapeServiceProtocol {
  public override init() { super.init() }

  open func getRectangle(id: UInt32) throws -> Rectangle   {
    fatalError("Subclass must implement getRectangle")
  }

  open func setRectangle(id: UInt32, rect: Rectangle) throws   {
    fatalError("Subclass must implement setRectangle")
  }

  // Dispatch incoming RPC calls
  public override func dispatch(buffer: FlatBuffer, remoteEndpoint: NPRPCEndpoint)   {
    guard let data = buffer.data else { return }

    // Read function index
    let functionIdx = data.load(fromByteOffset: 19, as: UInt8.self)

    switch functionIdx     {
      case 0: // getRectangle
      {
        
// Unmarshal input arguments
        let ia = unmarshal_test_swift_gen_M5(buffer: data, offset: 32)
        
        let _out_rect = try getRectangle(id: ia._1)
        
// Prepare output buffer
        let obuf = buffer
        obuf.consume(obuf.size)
        obuf.prepare(36)
        obuf.commit(36)
        
// Marshal output arguments
        guard let outData = buffer.data else { return }
        let out_data = (_1: _out_rect)
        marshal_test_swift_gen_M6(buffer: outData, offset: 16, data: out_data)
        outData.storeBytes(of: UInt32(buffer.size - 4), toByteOffset: 0, as: UInt32.self)
        outData.storeBytes(of: UInt32(2), toByteOffset: 4, as: UInt32.self)  // MessageId.BlockResponse
        outData.storeBytes(of: UInt32(1), toByteOffset: 8, as: UInt32.self)  // MessageType.Answer
      }
      case 1: // setRectangle
      {
        
// Unmarshal input arguments
        let ia = unmarshal_test_swift_gen_M7(buffer: data, offset: 32)
        
        try setRectangle(id: ia._1, rect: ia._2)
        
// Send success
        makeSimpleAnswer(buffer: buffer, messageId: 5)  // Success
      }
      default:
      {
        makeSimpleAnswer(buffer: buffer, messageId: 10)  // Error_UnknownFunctionIdx
      }
    }
 // switch
  }
 // dispatch
}

