// Generated by npidl compiler
// DO NOT EDIT - all changes will be lost

import NPRPC

public enum Color: Int32, Codable, Sendable {
  case red
  case green
  case blue
}

public struct Point: Codable, Sendable {
  public var x: Int32 = 0
  public var y: Int32 = 0

  public init() {}

  public init(x: Int32, y: Int32)   {
    self.x = x
    self.y = y
  }
}


// MARK: - Marshal Point
public func marshal_Point(buffer: UnsafeMutableRawPointer, offset: Int, data: Point) {
  buffer.storeBytes(of: data.x, toByteOffset: offset + 0, as: Int32.self)
  buffer.storeBytes(of: data.y, toByteOffset: offset + 4, as: Int32.self)
}

// MARK: - Unmarshal Point
public func unmarshal_Point(buffer: UnsafeRawPointer, offset: Int) -> Point {
  var result = Point()
  result.x = buffer.load(fromByteOffset: offset + 0, as: Int32.self)
  result.y = buffer.load(fromByteOffset: offset + 4, as: Int32.self)
  return result
}

public struct Rectangle: Codable, Sendable {
  public var topLeft: Point = Point()
  public var bottomRight: Point = Point()
  public var color: Color = .red

  public init() {}

  public init(topLeft: Point, bottomRight: Point, color: Color)   {
    self.topLeft = topLeft
    self.bottomRight = bottomRight
    self.color = color
  }
}


// MARK: - Marshal Rectangle
public func marshal_Rectangle(buffer: UnsafeMutableRawPointer, offset: Int, data: Rectangle) {
  marshal_Point(buffer: buffer, offset: offset + 0, data: data.topLeft)
  marshal_Point(buffer: buffer, offset: offset + 8, data: data.bottomRight)
  buffer.storeBytes(of: data.color.rawValue, toByteOffset: offset + 16, as: Int32.self)
}

// MARK: - Unmarshal Rectangle
public func unmarshal_Rectangle(buffer: UnsafeRawPointer, offset: Int) -> Rectangle {
  var result = Rectangle()
  result.topLeft = unmarshal_Point(buffer: buffer, offset: offset + 0)
  result.bottomRight = unmarshal_Point(buffer: buffer, offset: offset + 8)
  result.color = Color(rawValue: buffer.load(fromByteOffset: offset + 16, as: Int32.self))!
  return result
}


public struct basic_test_M1 {
  public var _1: UInt32 = 0
  public init() {}
}

public struct basic_test_M2 {
  public var _1: Rectangle = Rectangle()
  public init() {}
}

public struct basic_test_M3 {
  public var _1: UInt32 = 0
  public var _2: Rectangle = Rectangle()
  public init() {}
}

// MARK: - Marshal basic_test_M1
public func marshal_basic_test_M1(buffer: UnsafeMutableRawPointer, offset: Int, data: basic_test_M1) {
  buffer.storeBytes(of: data._1, toByteOffset: offset + 0, as: UInt32.self)
}

// MARK: - Unmarshal basic_test_M1
public func unmarshal_basic_test_M1(buffer: UnsafeRawPointer, offset: Int) -> basic_test_M1 {
  var result = basic_test_M1()
  result._1 = buffer.load(fromByteOffset: offset + 0, as: UInt32.self)
  return result
}


// MARK: - Marshal basic_test_M2
public func marshal_basic_test_M2(buffer: UnsafeMutableRawPointer, offset: Int, data: basic_test_M2) {
  marshal_Rectangle(buffer: buffer, offset: offset + 0, data: data._1)
}

// MARK: - Unmarshal basic_test_M2
public func unmarshal_basic_test_M2(buffer: UnsafeRawPointer, offset: Int) -> basic_test_M2 {
  var result = basic_test_M2()
  result._1 = unmarshal_Rectangle(buffer: buffer, offset: offset + 0)
  return result
}


// MARK: - Marshal basic_test_M3
public func marshal_basic_test_M3(buffer: UnsafeMutableRawPointer, offset: Int, data: basic_test_M3) {
  buffer.storeBytes(of: data._1, toByteOffset: offset + 0, as: UInt32.self)
  marshal_Rectangle(buffer: buffer, offset: offset + 4, data: data._2)
}

// MARK: - Unmarshal basic_test_M3
public func unmarshal_basic_test_M3(buffer: UnsafeRawPointer, offset: Int) -> basic_test_M3 {
  var result = basic_test_M3()
  result._1 = buffer.load(fromByteOffset: offset + 0, as: UInt32.self)
  result._2 = unmarshal_Rectangle(buffer: buffer, offset: offset + 4)
  return result
}

public protocol ShapeServiceProtocol {
  func getRectangle(id: UInt32) throws -> Rectangle
  func setRectangle(id: UInt32, rect: Rectangle) throws
}

// Client proxy for ShapeService
// Pure Swift implementation with direct marshalling
public class ShapeService: NPRPCObjectProxy, ShapeServiceProtocol {
  public override init(_ object: NPRPCObject)   {
    super.init(object)
  }

  public override func getClass() -> String   {
    return "basic_test/swift.test.ShapeService"
  }

  public func getRectangle(id: UInt32) throws -> Rectangle   {
    // Prepare buffer
    let buffer = FlatBuffer()
    buffer.prepare(36)
    buffer.commit(36)
    guard let data = buffer.data else { throw BufferError(message: "Failed to get buffer data") }

    // Write message header
    data.storeBytes(of: UInt32(0), toByteOffset: 0, as: UInt32.self)  // size (set later)
    data.storeBytes(of: UInt32(1), toByteOffset: 4, as: UInt32.self)  // msg_id: FunctionCall
    data.storeBytes(of: UInt32(0), toByteOffset: 8, as: UInt32.self)  // msg_type: Request
    data.storeBytes(of: UInt32(0), toByteOffset: 12, as: UInt32.self) // reserved

    // Write call header
    data.storeBytes(of: object.poaIdx, toByteOffset: 16, as: UInt16.self)
    data.storeBytes(of: UInt8(0), toByteOffset: 18, as: UInt8.self)  // interface_idx
    data.storeBytes(of: UInt8(0), toByteOffset: 19, as: UInt8.self)  // function_idx
    data.storeBytes(of: object.objectId, toByteOffset: 24, as: UInt64.self)

    // Marshal input arguments
    var inArgs = basic_test_M1()
    inArgs._1 = id
    marshal_basic_test_M1(buffer: data, offset: 32, data: inArgs)

    data.storeBytes(of: UInt32(32), toByteOffset: 0, as: UInt32.self)

    // Send and receive
    try object.session.sendReceive(buffer: buffer, timeout: object.timeout)

    // Handle reply
    let stdReply = handleStandardReply(buffer: buffer)
    if stdReply != -1 { throw UnexpectedReplyError(message: "Unexpected reply") }

    guard let responseData = buffer.data else { throw BufferError(message: "Failed to get response data") }
    let out = unmarshal_basic_test_M2(buffer: responseData, offset: 16)
    return out._1
  }

  public func setRectangle(id: UInt32, rect: Rectangle) throws   {
    // Prepare buffer
    let buffer = FlatBuffer()
    buffer.prepare(56)
    buffer.commit(56)
    guard let data = buffer.data else { throw BufferError(message: "Failed to get buffer data") }

    // Write message header
    data.storeBytes(of: UInt32(0), toByteOffset: 0, as: UInt32.self)  // size (set later)
    data.storeBytes(of: UInt32(1), toByteOffset: 4, as: UInt32.self)  // msg_id: FunctionCall
    data.storeBytes(of: UInt32(0), toByteOffset: 8, as: UInt32.self)  // msg_type: Request
    data.storeBytes(of: UInt32(0), toByteOffset: 12, as: UInt32.self) // reserved

    // Write call header
    data.storeBytes(of: object.poaIdx, toByteOffset: 16, as: UInt16.self)
    data.storeBytes(of: UInt8(0), toByteOffset: 18, as: UInt8.self)  // interface_idx
    data.storeBytes(of: UInt8(1), toByteOffset: 19, as: UInt8.self)  // function_idx
    data.storeBytes(of: object.objectId, toByteOffset: 24, as: UInt64.self)

    // Marshal input arguments
    var inArgs = basic_test_M3()
    inArgs._1 = id
    inArgs._2 = rect
    marshal_basic_test_M3(buffer: data, offset: 32, data: inArgs)

    data.storeBytes(of: UInt32(52), toByteOffset: 0, as: UInt32.self)

    // Send and receive
    try object.session.sendReceive(buffer: buffer, timeout: object.timeout)

    // Handle reply
    let stdReply = handleStandardReply(buffer: buffer)
    if stdReply != 0 { throw UnexpectedReplyError(message: "Unexpected reply") }
  }

}

// Servant base for ShapeService
open class ShapeServiceServant: NPRPCServant, ShapeServiceProtocol {
  public override init() { super.init() }

  open func getRectangle(id: UInt32) throws -> Rectangle   {
    fatalError("Subclass must implement getRectangle")
  }

  open func setRectangle(id: UInt32, rect: Rectangle) throws   {
    fatalError("Subclass must implement setRectangle")
  }

  // Dispatch incoming RPC calls
  public override func dispatch(buffer: FlatBuffer, remoteEndpoint: NPRPCEndpoint)   {
    guard let data = buffer.data else { return }

    // Read function index
    let functionIdx = data.load(fromByteOffset: 19, as: UInt8.self)

    switch functionIdx     {
      case 0: // getRectangle
      do {
        // Unmarshal input arguments
        let ia = unmarshal_basic_test_M1(buffer: data, offset: 32)
        
        let _out_rect = try getRectangle(id: ia._1)
        // Prepare output buffer
        let obuf = buffer
        obuf.consume(obuf.size)
        obuf.prepare(36)
        obuf.commit(36)
        // Marshal output arguments
        guard let outData = buffer.data else { return }
        var out_data = basic_test_M2()
        out_data._1 = _out_rect

        marshal_basic_test_M2(buffer: outData, offset: 16, data: out_data)
        outData.storeBytes(of: UInt32(buffer.size - 4), toByteOffset: 0, as: UInt32.self)
        outData.storeBytes(of: UInt32(2), toByteOffset: 4, as: UInt32.self)  // MessageId.BlockResponse
        outData.storeBytes(of: UInt32(1), toByteOffset: 8, as: UInt32.self)  // MessageType.Answer
      }
      catch {
        makeSimpleAnswer(buffer: buffer, messageId: 10)  // Error in dispatch
      }
      case 1: // setRectangle
      do {
        // Unmarshal input arguments
        let ia = unmarshal_basic_test_M3(buffer: data, offset: 32)
        
        try setRectangle(id: ia._1, rect: ia._2)
        // Send success
        makeSimpleAnswer(buffer: buffer, messageId: 5)  // Success
      }
      catch {
        makeSimpleAnswer(buffer: buffer, messageId: 10)  // Error in dispatch
      }
      default:
        makeSimpleAnswer(buffer: buffer, messageId: 10)  // Error_UnknownFunctionIdx
    } // switch
  } // dispatch
}

