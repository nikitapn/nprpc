// Generated by npidl compiler
// DO NOT EDIT - all changes will be lost


public struct nprpc_nameserver_M1 {
  public var _1: ObjectPtr<Object> = ObjectPtr()
  public var _2: String = ""
  public init() {}
}

public struct nprpc_nameserver_M2 {
  public var _1: String = ""
  public init() {}
}

public struct nprpc_nameserver_M3 {
  public var _1: Bool = false
  public var _2: ObjectPtr<Object> = ObjectPtr()
  public init() {}
}

// MARK: - Marshal nprpc_nameserver_M1
public func marshal_nprpc_nameserver_M1(buffer: UnsafeMutableRawPointer, offset: Int, data: nprpc_nameserver_M1) {
  detail.marshal_ObjectId(buffer: buffer, offset: offset + 0, data: data._1.data)
  NPRPC.marshal_string(buffer: buffer, offset: offset + 48, string: data._2)
}

// MARK: - Unmarshal nprpc_nameserver_M1
public func unmarshal_nprpc_nameserver_M1(buffer: UnsafeRawPointer, offset: Int, endpoint: NPRPCEndpoint) -> nprpc_nameserver_M1 {
  var result = nprpc_nameserver_M1()
  result._1 = NPRPC.unmarshal_object_proxy(buffer: buffer, offset: offset + 0, endpoint: endpoint)
  result._2 = NPRPC.unmarshal_string(buffer: buffer, offset: offset + 48)
  return result
}


// MARK: - Marshal nprpc_nameserver_M2
public func marshal_nprpc_nameserver_M2(buffer: UnsafeMutableRawPointer, offset: Int, data: nprpc_nameserver_M2) {
  NPRPC.marshal_string(buffer: buffer, offset: offset + 0, string: data._1)
}

// MARK: - Unmarshal nprpc_nameserver_M2
public func unmarshal_nprpc_nameserver_M2(buffer: UnsafeRawPointer, offset: Int) -> nprpc_nameserver_M2 {
  var result = nprpc_nameserver_M2()
  result._1 = NPRPC.unmarshal_string(buffer: buffer, offset: offset + 0)
  return result
}


// MARK: - Marshal nprpc_nameserver_M3
public func marshal_nprpc_nameserver_M3(buffer: UnsafeMutableRawPointer, offset: Int, data: nprpc_nameserver_M3) {
  buffer.storeBytes(of: data._1, toByteOffset: offset + 0, as: Bool.self)
  detail.marshal_ObjectId(buffer: buffer, offset: offset + 8, data: data._2.data)
}

// MARK: - Unmarshal nprpc_nameserver_M3
public func unmarshal_nprpc_nameserver_M3(buffer: UnsafeRawPointer, offset: Int, endpoint: NPRPCEndpoint) -> nprpc_nameserver_M3 {
  var result = nprpc_nameserver_M3()
  result._1 = buffer.load(fromByteOffset: offset + 0, as: Bool.self)
  result._2 = NPRPC.unmarshal_object_proxy(buffer: buffer, offset: offset + 8, endpoint: endpoint)
  return result
}

public protocol NameserverProtocol {
  func bind(obj: ObjectPtr<Object>, name: String) throws
  func resolve(name: String) throws -> (Bool, ObjectPtr<Object>)
}

// Client proxy for Nameserver
// Pure Swift implementation with direct marshalling
public class Nameserver: NPRPCObjectProxy, NameserverProtocol {
  public override init(_ object: NPRPCObject)   {
    super.init(object)
  }

  public override func getClass() -> String   {
    return "nprpc_nameserver/nprpc.common.Nameserver"
  }

  public func bind(obj: ObjectPtr<Object>, name: String) throws   {
    // Prepare buffer
    let buffer = FlatBuffer()
    buffer.prepare(216)
    buffer.commit(88)
    guard let data = buffer.data else { throw BufferError(message: "Failed to get buffer data") }

    // Write message header
    data.storeBytes(of: UInt32(0), toByteOffset: 0, as: UInt32.self)  // size (set later)
    data.storeBytes(of: UInt32(1), toByteOffset: 4, as: UInt32.self)  // msg_id: FunctionCall
    data.storeBytes(of: UInt32(0), toByteOffset: 8, as: UInt32.self)  // msg_type: Request
    data.storeBytes(of: UInt32(0), toByteOffset: 12, as: UInt32.self) // reserved

    // Write call header
    data.storeBytes(of: object.poaIdx, toByteOffset: 16, as: UInt16.self)
    data.storeBytes(of: UInt8(0), toByteOffset: 18, as: UInt8.self)  // interface_idx
    data.storeBytes(of: UInt8(0), toByteOffset: 19, as: UInt8.self)  // function_idx
    data.storeBytes(of: object.objectId, toByteOffset: 24, as: UInt64.self)

    // Marshal input arguments
    var inArgs = nprpc_nameserver_M1()
    inArgs._1 = obj
    inArgs._2 = name
    marshal_nprpc_nameserver_M1(buffer: data, offset: 32, data: inArgs)

    data.storeBytes(of: UInt32(84), toByteOffset: 0, as: UInt32.self)

    // Send and receive
    try object.session.sendReceive(buffer: buffer, timeout: object.timeout)

    // Handle reply
    let stdReply = handleStandardReply(buffer: buffer)
    if stdReply != 0 { throw UnexpectedReplyError(message: "Unexpected reply") }
  }

  public func resolve(name: String) throws -> (Bool, ObjectPtr<Object>)   {
    // Prepare buffer
    let buffer = FlatBuffer()
    buffer.prepare(168)
    buffer.commit(40)
    guard let data = buffer.data else { throw BufferError(message: "Failed to get buffer data") }

    // Write message header
    data.storeBytes(of: UInt32(0), toByteOffset: 0, as: UInt32.self)  // size (set later)
    data.storeBytes(of: UInt32(1), toByteOffset: 4, as: UInt32.self)  // msg_id: FunctionCall
    data.storeBytes(of: UInt32(0), toByteOffset: 8, as: UInt32.self)  // msg_type: Request
    data.storeBytes(of: UInt32(0), toByteOffset: 12, as: UInt32.self) // reserved

    // Write call header
    data.storeBytes(of: object.poaIdx, toByteOffset: 16, as: UInt16.self)
    data.storeBytes(of: UInt8(0), toByteOffset: 18, as: UInt8.self)  // interface_idx
    data.storeBytes(of: UInt8(1), toByteOffset: 19, as: UInt8.self)  // function_idx
    data.storeBytes(of: object.objectId, toByteOffset: 24, as: UInt64.self)

    // Marshal input arguments
    var inArgs = nprpc_nameserver_M2()
    inArgs._1 = name
    marshal_nprpc_nameserver_M2(buffer: data, offset: 32, data: inArgs)

    data.storeBytes(of: UInt32(36), toByteOffset: 0, as: UInt32.self)

    // Send and receive
    try object.session.sendReceive(buffer: buffer, timeout: object.timeout)

    // Handle reply
    let stdReply = handleStandardReply(buffer: buffer)
    if stdReply != -1 { throw UnexpectedReplyError(message: "Unexpected reply") }

    guard let responseData = buffer.data else { throw BufferError(message: "Failed to get response data") }
    let out = unmarshal_nprpc_nameserver_M3(buffer: responseData, offset: 16, endpoint: object.endpoint)
    return (out._1, out._2)
  }

}

// Servant base for Nameserver
open class NameserverServant: NPRPCServant, NameserverProtocol {
  public override init() { super.init() }

  open func bind(obj: ObjectPtr<Object>, name: String) throws   {
    fatalError("Subclass must implement bind")
  }

  open func resolve(name: String) throws -> (Bool, ObjectPtr<Object>)   {
    fatalError("Subclass must implement resolve")
  }

  // Dispatch incoming RPC calls
  public override func dispatch(buffer: FlatBuffer, remoteEndpoint: NPRPCEndpoint)   {
    guard let data = buffer.data else { return }

    // Read function index
    let functionIdx = data.load(fromByteOffset: 19, as: UInt8.self)

    switch functionIdx     {
      case 0: // Bind
      do {
        // Unmarshal input arguments
        let ia = unmarshal_nprpc_nameserver_M1(buffer: data, offset: 32, endpoint: remoteEndpoint)
        
        try bind(obj: ia._1, name: ia._2)
        // Send success
        makeSimpleAnswer(buffer: buffer, messageId: 5)  // Success
      }
      catch {
        makeSimpleAnswer(buffer: buffer, messageId: 10)  // Error in dispatch
      }
      case 1: // Resolve
      do {
        // Unmarshal input arguments
        let ia = unmarshal_nprpc_nameserver_M2(buffer: data, offset: 32)
        // Prepare output buffer
        let obuf = buffer
        obuf.consume(obuf.size)
        obuf.prepare(200)
        obuf.commit(72)
        
        let (__ret_val, _out_obj) = try resolve(name: ia._1)
        // Marshal output arguments
        guard let outData = buffer.data else { return }
        var out_data = nprpc_nameserver_M3()
        out_data._1 = __ret_val
        out_data._2 = _out_obj

        marshal_nprpc_nameserver_M3(buffer: outData, offset: 16, data: out_data)
        outData.storeBytes(of: UInt32(buffer.size - 4), toByteOffset: 0, as: UInt32.self)
        outData.storeBytes(of: UInt32(2), toByteOffset: 4, as: UInt32.self)  // MessageId.BlockResponse
        outData.storeBytes(of: UInt32(1), toByteOffset: 8, as: UInt32.self)  // MessageType.Answer
      }
      catch {
        makeSimpleAnswer(buffer: buffer, messageId: 10)  // Error in dispatch
      }
      default:
        makeSimpleAnswer(buffer: buffer, messageId: 10)  // Error_UnknownFunctionIdx
    } // switch
  } // dispatch
}

