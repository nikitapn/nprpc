// Copyright (c) 2021-2025, Nikita Pennie <nikitapnn1@gmail.com>
// SPDX-License-Identifier: MIT

module nprpc;

alias oid_t     = u64;
alias poa_idx_t = u16;
alias oflags_t  = u16;
alias uuid_t    = u8[16];
alias ifs_idx_t = u8;
alias fn_idx_t  = u8;

exception ExceptionCommFailure {
  /** Error message */
  what: string;
}

exception ExceptionTimeout {}
exception ExceptionObjectNotExist {}
exception ExceptionUnknownFunctionIndex {}
exception ExceptionUnknownMessageId {}
exception ExceptionUnsecuredObject {
  class_id: string;
}
exception ExceptionBadAccess {}
exception ExceptionBadInput {}

enum LogLevel {
  off,
  critical,
  error,
  warn,
  info,
  debug,
  trace,
};

enum EndPointType {
  Tcp,
  TcpTethered,
  WebSocket,
  SecuredWebSocket,
  Http, // HTTP/1.1 or HTTP/3 (not implemented yet)
  SecuredHttp,
  SharedMemory,
  Udp,
  Quic
};

namespace detail {
message ObjectIdLocal {
  poa_idx: poa_idx_t;
  object_id: oid_t;
}

enum ObjectFlag {
  /**
    * false  - transient object
    * true   - persistent object
    */
  Persistent = 1,
  /**
    * true  - only one client can access the object in the existing opened session (this is for objects that originate from webbrowser or clients behind NAT)
    * false - multiple clients can access the object by opening multiple sessions
    */
  Tethered  = 2,
}

[force_helpers=1]
message ObjectId {
  object_id: oid_t;
  poa_idx: poa_idx_t;
  flags: oflags_t;
  /** UUID of the machine where the object was created */
  origin: uuid_t;
  class_id: string;
  /**
    * List of urls available for connection separated by ';'
    * Currently supported protocols:
    *   [PLAIN | TETHERED] tcp://<hostname|ip>:<port>
    *   [PLAIN]            ws://<hostname|ip>:<port>
    *   [SECURED]          wss://hostname>:<port>
    *   [PLAIN]            http://<hostname|ip>:<port>/rpc
    *   [SECURED]          https://<hostname>:<port>/rpc
    *   [PLAIN]            mem://<path>
    *   [SECURED]          quic://<hostname>:<port>
    */
  urls: string;
}

} // namespace detail

namespace impl {
enum MessageId: u32 {
  // Function call
  FunctionCall = 0,
  // Function response
  BlockResponse,
  // Increase reference count
  AddReference,
  // Decrease reference count
  ReleaseObject,
  // Success of the operation
  Success,
  // Generic exception
  Exception,
  // Poa does not exist
  Error_PoaNotExist,
  // Object does not exist
  Error_ObjectNotExist,
  // Timeout waiting for response
  Error_CommFailure,
  // Unknown function index
  Error_UnknownFunctionIdx,
  // Unknown message id
  Error_UnknownMessageId,
  // Attempt to access unsecured object
  Error_BadAccess,
  // Invalid input data (array out of bounds, etc)
  Error_BadInput
}

enum MessageType: u32 {
  Request = 0,
  Answer
}

message Header {
  size: u32;
  msg_id: MessageId;
  msg_type: MessageType;
  request_id: u32;
}

message CallHeader {
  poa_idx: poa_idx_t;
  interface_idx: ifs_idx_t;
  function_idx: fn_idx_t;
  object_id: oid_t;
}

} // namespace impl
