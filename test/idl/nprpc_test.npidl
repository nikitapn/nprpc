// Copyright (c) 2021-2025, Nikita Pennie <nikitapnn1@gmail.com>
// SPDX-License-Identifier: MIT

module nprpc.test;

alias Id = u32;
alias IdArray = vector<Id>;
alias bytestream = vector<u8>;

exception AssertionFailed {
	message: string;
}

// Simple ACK, for testing UDP unreliable delivery
interface Ack {
	// Simple ACK method
	// Made it async since it will be called io_context thread and we don't want to deadlock
	async Confirm(what: string);
}

interface ServerControl {
	// All tests performed, safe to shutdown the server
	void Shutdown();
	// Register ACK handler object to receive ACKs from server
	void RegisterAckHandler(handler: /* Ack */ object);
}

[force_helpers=1]
message FlatStruct {
	a: i32;
	b: u32;
	c: f32;
}

[force_helpers=1]
message AAA{
	a: u32;
	b: string;
	c: string;
}

[force_helpers=1]
message SimpleStruct {
	id: u32;
}

exception SimpleException {
	message: string;
	code: u32;
}

interface TestBasic {
	boolean ReturnBoolean() raises (AssertionFailed);
	IdArray ReturnIdArray() raises (AssertionFailed);
	u32 ReturnU32() raises (AssertionFailed);

	boolean In_(a: u32, b: boolean, c: vector<u8>) raises (AssertionFailed);
	void Out(a: out u32, b: out boolean, c: out vector<u8>) raises (AssertionFailed);

	void InStruct(a: AAA) raises (AssertionFailed);
	void OutStruct(a: out AAA) raises (AssertionFailed);
	void InFlatStruct(value: u32, a: FlatStruct) raises (AssertionFailed);
	void OutFlatStruct(value: u32, a: out FlatStruct) raises (AssertionFailed);
	void OutArrayOfStructs(a: out vector<SimpleStruct>) raises (AssertionFailed);

	void InException() raises (SimpleException);
	
	// Test case for flat output struct with simple scalar out parameter and exception handler
	// This tests the fix for variable scope when output params are declared before try block
	void OutScalarWithException(dev_addr: u8, addr: u16, value: out u8) raises (SimpleException);
}

interface TestLargeMessage {
	boolean In_(a: u32, b: boolean, c: vector<u8>);
	void Out(a: out u32, b: out boolean, c: out vector<u8>);
}

[force_helpers=1]
message Opt1 {
	str: string;
	data?: bytestream;
};

interface TestOptional {
	boolean InEmpty(a?: u32) raises (AssertionFailed);
	boolean In_(a?: u32, b?: AAA) raises (AssertionFailed);
//	boolean InVec(a?: bytestream);

	void OutEmpty(a?: out u32) raises (AssertionFailed);
	void Out(a?: out u32) raises (AssertionFailed);

	Opt1 ReturnOpt1() raises (AssertionFailed);
}

interface SimpleObject {
	async SetValue(a: u32);
}

message NestedObjects {
	object1: /* SimpleObject */ object;
	object2: /* SimpleObject */ object;
}

interface TestObjects {
	void SendObject(o: /* SimpleObject */ object) raises (AssertionFailed);
	void ReleaseReceivedObject() raises (AssertionFailed);

	void SendNestedObjects(o: NestedObjects) raises (AssertionFailed);
}

[force_helpers=1]
message CCC {
	a: string;
	b: string;
	c?: boolean;
}

[force_helpers=1]
message BBB {
	a: vector<AAA>;
	b: vector<CCC>;
}

[force_helpers=1]
message Level2 {
	x: string;
	y: vector<u8>;
	z: u64;
}

[force_helpers=1]
message Level1 {
	x: string;
	y: Level2;
	z: u64;
}

[force_helpers=1]
message TopLevel {
	x: string;
	y: Level1;
	z: u64;
}

interface TestNested {
	void Out(a?: out BBB) raises (AssertionFailed);
	TopLevel ReturnNested() raises (AssertionFailed);
}

[trusted=false]
interface TestBadInput {
	void In_(a: vector<u8>);
}

interface TestUnreliable {
	// Unreliable, no reply
	[unreliable]
	async FireAndForget(a: u32, b: boolean, c: vector<u8>);

	// Reliable UDP - needs ACK, can have return value and throw
	boolean ReliableCall(a: u32, b: boolean, c: vector<u8>) raises (AssertionFailed);
}

interface TestStreams {
	[unreliable]
	stream<u8> GetByteStream(size: u64);
	// stream<AAA> GetObjectStream(count: u32);
}

interface AsyncTest {
	// Test async method with no return value
	async Method1(arg1: u32, arg2: string);

	// Test async method with output value
	async Method2(arg1: u32, arg2: out string);

	// Test async method that can throw an exception
	// Async methods cannot throw an exception at this time because it would require callback parameters in C++.
	// Future enhancement could allow async methods to throw exceptions that are delivered to the caller as rejections of the returned promise.
	// In C++ the exception would be in the callback parameters.
	// async Method3(arg1: u32) raises (AssertionFailed);
}

interface FixedSizeArrayTest {
	// Test fixed size array of 10 integers
	void InFixedArray(a: u32[10]) raises (AssertionFailed);
	void OutFixedArray(a: out u32[10]) raises (AssertionFailed);
	void OutTwoFixedArrays(a: out u32[10], b: out u32[10]) raises (AssertionFailed);

	void InFixedArrayOfStructs(a: SimpleStruct[5]) raises (AssertionFailed);
	void OutFixedArrayOfStructs(a: out SimpleStruct[5]) raises (AssertionFailed);
	void OutTwoFixedArraysOfStructs(a: out SimpleStruct[5], b: out AAA[5]) raises (AssertionFailed);
}