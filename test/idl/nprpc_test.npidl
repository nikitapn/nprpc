// Copyright (c) 2022 nikitapnn1@gmail.com
// This file is a part of npsystem (Distributed Control System) and covered by LICENSING file in the topmost directory

module nprpc.test;

alias Id = u32;
alias IdArray = vector<Id>;
alias bytestream = vector<u8>;

exception AssertionFailed {
	message: string;
}

// Simple ACK, for testing UDP unreliable delivery
interface Ack {
	// Simple ACK method
	// Made it async since it will be called io_context thread and we don't want to deadlock
	async Confirm(what: in string);
}

interface ServerControl {
	// All tests performed, safe to shutdown the server
	void Shutdown();
	// Register ACK handler object to receive ACKs from server
	void RegisterAckHandler(handler: in /* Ack */ object);
}

[force_helpers=1]
message FlatStruct {
	a: i32;
	b: u32;
	c: f32;
}

[force_helpers=1]
message AAA{
	a: u32;
	b: string;
	c: string;
}

[force_helpers=1]
message SimpleStruct {
	id: u32;
}

exception SimpleException {
	message: string;
	code: u32;
}

interface TestBasic {
	boolean ReturnBoolean() raises (AssertionFailed);
	IdArray ReturnIdArray() raises (AssertionFailed);
	u32 ReturnU32() raises (AssertionFailed);

	boolean In(a: in u32, b: in boolean, c: in vector<u8>) raises (AssertionFailed);
	void Out(a: out u32, b: out boolean, c: out vector<u8>) raises (AssertionFailed);

	void OutStruct(a: out AAA) raises (AssertionFailed);
	void OutArrayOfStructs(a: out vector<SimpleStruct>) raises (AssertionFailed);

	void InException() raises (SimpleException);
	
	// Test case for flat output struct with simple scalar out parameter and exception handler
	// This tests the fix for variable scope when output params are declared before try block
	void OutScalarWithException(dev_addr: in u8, addr: in u16, value: out u8) raises (SimpleException);
}

interface TestLargeMessage {
	boolean In(a: in u32, b: in boolean, c: in vector<u8>);
	void Out(a: out u32, b: out boolean, c: out vector<u8>);
}

[force_helpers=1]
message Opt1 {
	str: string;
	stream?: bytestream;
};

interface TestOptional {
	boolean InEmpty(a?: in u32) raises (AssertionFailed);
	boolean In(a?: in u32, b?: in AAA) raises (AssertionFailed);
//	boolean InVec(a?: in bytestream);

	void OutEmpty(a?: out u32) raises (AssertionFailed);
	void Out(a?: out u32) raises (AssertionFailed);

	Opt1 ReturnOpt1() raises (AssertionFailed);
}

interface SimpleObject {
	async SetValue(a: in u32);
}

message NestedObjects {
	object1: /* SimpleObject */ object;
	object2: /* SimpleObject */ object;
}

interface TestObjects {
	void SendObject(o: in /* SimpleObject */ object) raises (AssertionFailed);
	void ReleaseReceivedObject() raises (AssertionFailed);

	void SendNestedObjects(o: in NestedObjects) raises (AssertionFailed);
}

[force_helpers=1]
message CCC {
	a: string;
	b: string;
	c?: boolean;
}

[force_helpers=1]
message BBB {
	a: vector<AAA>;
	b: vector<CCC>;
}

[force_helpers=1]
message Level2 {
	x: string;
	y: vector<u8>;
	z: u64;
}

[force_helpers=1]
message Level1 {
	x: string;
	y: Level2;
	z: u64;
}

[force_helpers=1]
message TopLevel {
	x: string;
	y: Level1;
	z: u64;
}

interface TestNested {
	void Out(a?: out BBB) raises (AssertionFailed);
	TopLevel ReturnNested() raises (AssertionFailed);
}

[trusted=false]
interface TestBadInput {
	void In(a: in vector<u8>);
}

interface TestUnreliable {
	// Unreliable, no reply
	[unreliable]
	async FireAndForget(a: in u32, b: in boolean, c: in vector<u8>);

	// Reliable UDP - needs ACK, can have return value and throw
	boolean ReliableCall(a: in u32, b: in boolean, c: in vector<u8>) raises (AssertionFailed);
}